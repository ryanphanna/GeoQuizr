<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transit Trivia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.4;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .content-wrapper {
            flex: 1;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metro-icon {
            display: inline-block;
            background: white;
            color: #1e3c72;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            line-height: 28px;
            font-weight: bold;
            font-size: 1em;
        }

        .user-info {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s ease;
            min-width: 40px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .score-display {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .user-level {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 5px;
        }

        .container {
            max-width: 100%;
            padding: 15px;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        .see-all {
            color: #1e3c72;
            font-size: 0.9em;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        /* Homepage carousel */
        .carousel {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .carousel::-webkit-scrollbar {
            display: none;
        }

        /* Streak banner */
        .streak-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
            font-size: 0.9em;
            text-align: center;
            display: block;
        }

        /* Quick Play card */
        .quick-play-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
            font-size: 0.95em;
        }

        .quick-play-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Game mode cards */
        .game-mode-card {
            min-width: 200px;
            background: white;
            border: 2px solid #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .game-mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .game-mode-card.stations::before {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .game-mode-card.routes::before {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .game-mode-card.nextstation::before {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .game-mode-card.trivia::before {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .game-mode-card.geography::before {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .game-mode-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #1e3c72;
        }

        .game-mode-card .icon {
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
        }

        .game-mode-card .title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 6px;
            font-size: 1em;
        }

        .game-mode-card .subtitle {
            font-size: 0.85em;
            color: #666;
            line-height: 1.3;
        }

        .game-mode-card .question-count {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f8f9fa;
            color: #666;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 500;
        }

        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Progress to next level */
        .level-progress {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .level-progress-bar {
            background: #e2e8f0;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .level-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        /* Leaderboard preview */
        .leaderboard-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            font-weight: bold;
            color: #1e3c72;
            margin-right: 10px;
            font-size: 1.1em;
        }

        .leaderboard-name {
            flex: 1;
            font-weight: 500;
        }

        .leaderboard-score {
            color: #666;
            font-weight: 600;
        }

        /* Quiz interface */
        .quiz-container {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .question-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .question-text {
            font-size: 1.2em;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .hint-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { 
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .timer-bar {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            border-radius: 2px;
            transition: width 1s linear;
        }

        .timer-fill.warning {
            background: linear-gradient(90deg, #ffc107 0%, #ff9800 100%);
        }

        .timer-fill.danger {
            background: linear-gradient(90deg, #ff6b6b 0%, #ff4757 100%);
        }

        .route-diagram {
            background: #f8f9fa;
            border: 3px solid #1e3c72;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .route-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            position: relative;
        }

        .route-line::before {
            content: '';
            position: absolute;
            left: 20px;
            right: 20px;
            height: 8px;
            background: currentColor;
            z-index: 0;
        }

        .station-dot {
            width: 24px;
            height: 24px;
            background: white;
            border: 4px solid currentColor;
            border-radius: 50%;
            z-index: 1;
            position: relative;
        }

        .station-dot.terminal {
            width: 30px;
            height: 30px;
        }

        .options-grid {
            display: grid;
            gap: 10px;
        }

        .option-btn {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1em;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-btn:hover {
            border-color: #1e3c72;
            background: #f0f4ff;
            transform: translateX(5px);
        }

        .option-btn.correct {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .option-btn.incorrect {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }

        .option-btn.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .type-answer-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .type-answer-input:focus {
            outline: none;
            border-color: #1e3c72;
        }

        /* Progress bar */
        .progress-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 0.9em;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            color: #333;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Empty states */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .hidden {
            display: none !important;
        }

        /* Loading spinner */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e3c72;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Countdown animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        #countdown {
            display: inline-block;
            animation: pulse 1s ease-in-out infinite;
            font-weight: bold;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .game-mode-card {
                min-width: 180px;
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="header">
            <div class="header-row">
                <h1 class="header-title" onclick="goHome()">
                    <span class="metro-icon">M</span>
                    Transit Trivia
                </h1>
                <div class="user-info">
                    <div class="score-display" id="scoreDisplay">
                        ⭐ 0 pts
                        <span class="user-level" id="userLevel">Rookie</span>
                    </div>
                    <button class="header-btn" onclick="showProfile()">👤</button>
                    <button class="header-btn" onclick="showLeaderboard()">🏆</button>
                    <button class="header-btn" onclick="showAddQuestion()">➕</button>
                </div>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="container">
                <!-- Homepage -->
                <div id="homepageSection">
                    <!-- Streak Banner -->
                    <div class="streak-banner" id="streakBanner">
                        <span id="streakText">⚡ Take your first quiz to start a streak!</span>
                    </div>

                    <!-- Quick Play -->
                    <div class="quick-play-card" onclick="startQuickPlay()">
                        ⚡ Quick Play • Random game mode
                    </div>

                    <!-- Game Modes -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">🎮 Game Modes</h2>
                        </div>
                        <div class="carousel">
                            <div class="game-mode-card stations" onclick="startGame('stations')">
                                <span class="question-count" id="stationsCount">0</span>
                                <span class="icon">🎰</span>
                                <div class="title">Platform Pop Quiz</div>
                                <div class="subtitle">Station-specific questions & identification</div>
                            </div>
                            <div class="game-mode-card routes" onclick="startGame('routes')">
                                <span class="question-count" id="routesCount">0</span>
                                <span class="icon">🗺️</span>
                                <div class="title">Route Runner</div>
                                <div class="subtitle">Identify lines from visual diagrams</div>
                            </div>
                            <div class="game-mode-card nextstation" onclick="startGame('nextstation')">
                                <span class="question-count" id="nextstationCount">0</span>
                                <span class="icon">🚉</span>
                                <div class="title">Next Stop</div>
                                <div class="subtitle">What's the next station?</div>
                            </div>
                            <div class="game-mode-card trivia" onclick="startGame('trivia')">
                                <span class="question-count" id="triviaCount">0</span>
                                <span class="icon">🧠</span>
                                <div class="title">Transit IQ</div>
                                <div class="subtitle">Facts, stats & system knowledge</div>
                            </div>
                            <div class="game-mode-card geography" onclick="startGame('geography')">
                                <span class="question-count" id="geographyCount">0</span>
                                <span class="icon">🌍</span>
                                <div class="title">City Geography</div>
                                <div class="subtitle">Counties, regions & city locations</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">📊 Recent Activity</h2>
                        </div>
                        <div id="recentActivity" class="empty-state">
                            <div class="empty-state-icon">🚇</div>
                            <div>Start playing to see your activity</div>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" class="section hidden">
                    <h2>👤 Your Profile</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="profileScore">0</div>
                            <div class="stat-label">All-Time Score</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <div class="stat-value" id="profileScore30">0</div>
                            <div class="stat-label">Last 30 Days</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <div class="stat-value" id="profileGames">0</div>
                            <div class="stat-label">Games Played</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <div class="stat-value" id="profileQuestions">0</div>
                            <div class="stat-label">Questions Added</div>
                        </div>
                    </div>

                    <div class="level-progress">
                        <h3 style="margin-bottom: 10px;">Level Progress</h3>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span id="currentLevelText">Rookie</span>
                            <span id="nextLevelText">Transit Fan (100 pts)</span>
                        </div>
                        <div class="level-progress-bar">
                            <div class="level-progress-fill" id="levelProgressFill" style="width: 0%;"></div>
                        </div>
                        <div style="text-align: center; color: #666; font-size: 0.9em;">
                            <span id="levelProgressText">0 / 100 points</span>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn" style="background: #dc3545; color: white;" onclick="logout()">
                            Sign Out
                        </button>
                    </div>
                </div>

                <!-- Leaderboard Section -->
                <div id="leaderboardSection" class="section hidden">
                    <h2>🏆 Leaderboard</h2>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="loadLeaderboard('all')" id="btnAllTime">All Time</button>
                        <button class="btn" style="background: #6c757d; color: white;" onclick="loadLeaderboard('30')" id="btn30Days">Last 30 Days</button>
                    </div>
                    
                    <div id="leaderboardList">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <div>Loading rankings...</div>
                        </div>
                    </div>
                </div>

                <!-- Add Question Section -->
                <div id="addQuestionSection" class="section hidden">
                    <h2>➕ Add New Question</h2>
                    
                    <div class="form-group">
                        <label>City/System:</label>
                        <select id="newCity">
                            <option value="Toronto">🍁 Toronto (TTC)</option>
                            <option value="Vancouver">🏔️ Vancouver (TransLink)</option>
                            <option value="Montreal">⚜️ Montreal (STM)</option>
                            <option value="Chicago">🏙️ Chicago (CTA)</option>
                            <option value="New York">🗽 New York (MTA)</option>
                            <option value="Albany">🏛️ Albany (CDTA)</option>
                            <option value="San Francisco">🌉 San Francisco (BART/Muni)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Question Type:</label>
                        <select id="newMode">
                            <option value="stations">🎰 Platform Pop Quiz</option>
                            <option value="routes">🗺️ Route Runner</option>
                            <option value="nextstation">🚉 Next Stop</option>
                            <option value="trivia">🧠 Transit IQ</option>
                            <option value="geography">🌍 City Geography</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Answer Type:</label>
                        <select id="answerType">
                            <option value="multiple">Multiple Choice</option>
                            <option value="type">Type Answer</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Question:</label>
                        <textarea id="newQuestion" rows="3" placeholder="e.g., What county is Toronto located in?"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Correct Answer:</label>
                        <input type="text" id="newCorrect" placeholder="e.g., Toronto Division">
                    </div>

                    <div class="form-group" id="wrongOptionsGroup">
                        <label>Wrong Options (comma separated):</label>
                        <input type="text" id="newWrong" placeholder="e.g., York Region, Peel Region, Durham Region">
                    </div>

                    <div class="form-group">
                        <label>Hint (optional, shows after 10 seconds):</label>
                        <input type="text" id="newHint" placeholder="e.g., It's not a regional municipality">
                    </div>

                    <button class="btn btn-primary" onclick="addQuestion()">Submit Question</button>
                    
                    <div id="addFeedback"></div>
                </div>

                <!-- Quiz Section -->
                <div id="quizSection" class="hidden">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%;"></div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="color: #666;">Question <span id="currentQ">1</span>/<span id="totalQ">10</span></span>
                        <span style="color: #1e3c72; font-weight: 600;">Score: <span id="quizScore">0</span></span>
                    </div>

                    <div class="question-card">
                        <div class="timer-bar" id="timerBar" style="display: none;">
                            <div class="timer-fill" id="timerFill"></div>
                        </div>
                        
                        <h3 class="question-text" id="questionText"></h3>
                        
                        <div class="hint-box" id="hintBox">
                            💡 <span id="hintText"></span>
                        </div>
                        
                        <div id="questionContent"></div>
                        
                        <div id="answerArea"></div>
                    </div>

                    <div id="feedback" class="hidden" style="padding: 15px; border-radius: 10px; margin-bottom: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let db = null;
        let currentUser = null;
        let currentQuiz = null;
        let allQuestions = [];
        let currentMode = '';
        let currentStreak = 0;
        let hintTimer = null;
        let questionTimer = null;
        let autoAdvanceTimer = null;
        let hintShown = false;

        // Level system
        const levels = [
            { name: 'Rookie', minScore: 0, color: '#9CA3AF' },
            { name: 'Transit Fan', minScore: 100, color: '#60A5FA' },
            { name: 'Route Expert', minScore: 250, color: '#34D399' },
            { name: 'Station Master', minScore: 500, color: '#A78BFA' },
            { name: 'City Navigator', minScore: 1000, color: '#F59E0B' },
            { name: 'Transit Guru', minScore: 2000, color: '#EF4444' },
            { name: 'Metro Legend', minScore: 5000, color: '#EC4899' }
        ];

        // Sample questions
        const sampleQuestions = [
            {
                city: 'Toronto',
                mode: 'nextstation',
                question: "You're at Bloor-Yonge on Line 1 heading north. What's the next station?",
                correct: 'Rosedale',
                wrong: ['Summerhill', 'St. Clair', 'Davisville'],
                answerType: 'multiple',
                hint: 'It starts with R and is named after a neighborhood'
            },
            {
                city: 'Toronto',
                mode: 'stations',
                question: 'Which TTC station has the deepest platform below street level?',
                correct: 'Lawrence',
                wrong: ['St. Clair', 'Eglinton', 'York Mills'],
                answerType: 'multiple',
                hint: 'It\'s on Line 1 between Eglinton and York Mills'
            },
            {
                city: 'Toronto',
                mode: 'trivia',
                question: 'What year did the Toronto subway first open?',
                correct: '1954',
                wrong: ['1949', '1963', '1971'],
                answerType: 'type',
                hint: 'It was in the 1950s'
            },
            {
                city: 'Toronto',
                mode: 'geography',
                question: 'Toronto was formerly part of which county?',
                correct: 'York County',
                wrong: ['Peel County', 'Durham County', 'Halton County'],
                answerType: 'multiple',
                hint: 'It shares the name with a region that surrounds Toronto today'
            },
            {
                city: 'Vancouver',
                mode: 'trivia',
                question: 'How many SkyTrain lines does Vancouver have?',
                correct: '3',
                wrong: ['2', '4', '5'],
                answerType: 'multiple',
                hint: 'Expo, Millennium, and one more...'
            },
            {
                city: 'Vancouver',
                mode: 'geography',
                question: 'Which regional district is Vancouver part of?',
                correct: 'Metro Vancouver',
                wrong: ['Fraser Valley', 'Capital Regional District', 'Central Okanagan'],
                answerType: 'multiple',
                hint: 'It includes the word that describes the urban area'
            },
            {
                city: 'Montreal',
                mode: 'nextstation',
                question: "You're at Berri-UQAM on the Orange Line heading toward Côte-Vertu. What's the next station?",
                correct: 'Sherbrooke',
                wrong: ['Mont-Royal', 'Laurier', 'Rosemont'],
                answerType: 'type',
                hint: 'Named after a major street that runs east-west'
            },
            {
                city: 'Montreal',
                mode: 'geography',
                question: 'Montreal is located on which island?',
                correct: 'Island of Montreal',
                wrong: ['Île Jésus', 'Île Perrot', 'Île Bizard'],
                answerType: 'multiple',
                hint: 'The island shares its name with the city'
            },
            {
                city: 'New York',
                mode: 'trivia',
                question: 'How many numbered subway lines does NYC have?',
                correct: '10',
                wrong: [],
                answerType: 'type',
                hint: 'Count 1, 2, 3, 4, 5, 6, 7... and three more'
            },
            {
                city: 'Chicago',
                mode: 'trivia',
                question: 'What color is the CTA line that goes to O\'Hare Airport?',
                correct: 'Blue',
                wrong: [],
                answerType: 'type',
                hint: 'It\'s a primary color, not red'
            },
            {
                city: 'Chicago',
                mode: 'geography',
                question: 'Which county is Chicago located in?',
                correct: 'Cook County',
                wrong: ['DuPage County', 'Lake County', 'Will County'],
                answerType: 'multiple',
                hint: 'It starts with C'
            },
            {
                city: 'Albany',
                mode: 'trivia',
                question: 'What U.S. transit agency operates PlusBus?',
                correct: 'CDTA',
                wrong: ['MTA', 'SEPTA', 'WMATA'],
                answerType: 'multiple',
                hint: 'This agency serves New York\'s capital region'
            }
        ];

        // Route diagrams
        const routeDiagrams = {
            'Toronto-Line1': {
                city: 'Toronto',
                line: 'Line 1 Yonge-University',
                color: '#ffcc00',
                stations: ['Finch', '...', 'Sheppard-Yonge', '...', 'Bloor-Yonge', '...', 'Union', '...', 'Vaughan MC']
            },
            'Toronto-Line2': {
                city: 'Toronto',
                line: 'Line 2 Bloor-Danforth',
                color: '#00a651',
                stations: ['Kipling', '...', 'St. George', '...', 'Bloor-Yonge', '...', 'Kennedy']
            },
            'Vancouver-CanadaLine': {
                city: 'Vancouver',
                line: 'Canada Line',
                color: '#009ddc',
                stations: ['Waterfront', '...', 'City Centre', '...', 'Marine Drive', '...', 'YVR Airport']
            },
            'Montreal-Orange': {
                city: 'Montreal',
                line: 'Orange Line',
                color: '#f97b00',
                stations: ['Côte-Vertu', '...', 'Lionel-Groulx', '...', 'Berri-UQAM', '...', 'Montmorency']
            }
        };

        // Define all window functions BEFORE Firebase loads
        window.goHome = function() {
            hideAllSections();
            document.getElementById('homepageSection').classList.remove('hidden');
            updateHomepage();
        }

        window.showProfile = function() {
            hideAllSections();
            document.getElementById('profileSection').classList.remove('hidden');
            updateProfile();
        }

        window.showLeaderboard = function() {
            hideAllSections();
            document.getElementById('leaderboardSection').classList.remove('hidden');
            if (db) loadLeaderboard('all');
        }

        window.showAddQuestion = function() {
            hideAllSections();
            document.getElementById('addQuestionSection').classList.remove('hidden');
            
            const answerTypeSelect = document.getElementById('answerType');
            const wrongOptionsGroup = document.getElementById('wrongOptionsGroup');
            
            answerTypeSelect.addEventListener('change', function() {
                wrongOptionsGroup.style.display = this.value === 'multiple' ? 'block' : 'none';
            });
        }

        window.startQuickPlay = function() {
            const modes = ['stations', 'routes', 'nextstation', 'trivia', 'geography'];
            const randomMode = modes[Math.floor(Math.random() * modes.length)];
            startGame(randomMode);
        }

        window.startGame = function(mode) {
            currentMode = mode;
            
            let questions = allQuestions.filter(q => {
                if (q.mode === 'systems') q.mode = 'trivia';
                return q.mode === mode;
            });
            
            if (mode === 'routes') {
                const routeQuestions = createRouteQuestions();
                questions = [...questions, ...routeQuestions];
            }
            
            if (questions.length === 0) {
                alert('No questions available for this mode yet');
                return;
            }
            
            const shuffled = questions.sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, Math.min(10, shuffled.length));
            
            currentQuiz = {
                questions: selected,
                currentIndex: 0,
                score: 0,
                mode: mode
            };
            
            hideAllSections();
            
            // Restore quiz section structure if it was replaced
            const quizSection = document.getElementById('quizSection');
            quizSection.innerHTML = `
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%;"></div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span style="color: #666;">Question <span id="currentQ">1</span>/<span id="totalQ">10</span></span>
                    <span style="color: #1e3c72; font-weight: 600;">Score: <span id="quizScore">0</span></span>
                </div>

                <div class="question-card">
                    <div class="timer-bar" id="timerBar" style="display: none;">
                        <div class="timer-fill" id="timerFill"></div>
                    </div>
                    
                    <h3 class="question-text" id="questionText"></h3>
                    
                    <div class="hint-box" id="hintBox">
                        💡 <span id="hintText"></span>
                    </div>
                    
                    <div id="questionContent"></div>
                    
                    <div id="answerArea"></div>
                </div>

                <div id="feedback" class="hidden" style="padding: 15px; border-radius: 10px; margin-bottom: 20px;"></div>
            `;
            
            quizSection.classList.remove('hidden');
            document.getElementById('totalQ').textContent = selected.length;
            
            showQuestion();
        }

        window.hideAllSections = function() {
            document.getElementById('homepageSection').classList.add('hidden');
            document.getElementById('profileSection').classList.add('hidden');
            document.getElementById('leaderboardSection').classList.add('hidden');
            document.getElementById('addQuestionSection').classList.add('hidden');
            document.getElementById('quizSection').classList.add('hidden');
        }

        window.nextQuestion = function() {
            if (!currentQuiz) return;
            currentQuiz.currentIndex++;
            showQuestion();
        }

        window.logout = function() {
            if (confirm('Are you sure you want to sign out?')) {
                localStorage.removeItem('transitTriviaUser');
                localStorage.removeItem('transitTriviaScore');
                localStorage.removeItem('transitTriviaGames');
                location.reload();
            }
        }

        window.checkAnswer = function(selected, correct) {
            const isCorrect = selected === correct;
            processAnswer(isCorrect, correct, selected);
        }

        window.checkTypeAnswer = function(event) {
            if (event.key === 'Enter') {
                submitTypeAnswer();
            }
        }

        window.submitTypeAnswer = function() {
            const answer = document.getElementById('typeAnswer').value.trim();
            const question = currentQuiz.questions[currentQuiz.currentIndex];
            const isCorrect = answer.toLowerCase() === question.correct.toLowerCase();
            processAnswer(isCorrect, question.correct, answer);
        }

        window.addQuestion = function() {
            const city = document.getElementById('newCity').value;
            const mode = document.getElementById('newMode').value;
            const answerType = document.getElementById('answerType').value;
            const question = document.getElementById('newQuestion').value.trim();
            const correct = document.getElementById('newCorrect').value.trim();
            const hint = document.getElementById('newHint').value.trim();
            
            if (!question || !correct) {
                alert('Please fill in the question and correct answer');
                return;
            }
            
            let wrongOptions = [];
            if (answerType === 'multiple') {
                const wrong = document.getElementById('newWrong').value.trim();
                if (!wrong) {
                    alert('Please provide wrong options for multiple choice');
                    return;
                }
                wrongOptions = wrong.split(',').map(opt => opt.trim()).filter(opt => opt);
                if (wrongOptions.length < 3) {
                    alert('Please provide at least 3 wrong options');
                    return;
                }
            }
            
            const newQuestion = {
                city: city,
                mode: mode,
                answerType: answerType,
                question: question,
                correct: correct,
                wrong: wrongOptions.slice(0, 3),
                hint: hint || null,
                addedBy: currentUser ? currentUser.username : 'Anonymous',
                addedAt: new Date()
            };
            
            // Add to local array immediately
            allQuestions.push(newQuestion);
            updateQuestionCounts();
            
            // Try to save to database if available
            if (db) {
                db.collection('questions').add(newQuestion).then(() => {
                    if (currentUser) {
                        db.collection('users').doc(currentUser.username).update({
                            questionsAdded: firebase.firestore.FieldValue.increment(1)
                        });
                        currentUser.questionsAdded = (currentUser.questionsAdded || 0) + 1;
                    }
                }).catch(error => {
                    console.error('Error saving to database:', error);
                });
            }
            
            document.getElementById('addFeedback').innerHTML = `
                <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    ✓ Question added successfully
                </div>
            `;
            
            document.getElementById('newQuestion').value = '';
            document.getElementById('newCorrect').value = '';
            document.getElementById('newWrong').value = '';
            document.getElementById('newHint').value = '';
            
            setTimeout(() => {
                document.getElementById('addFeedback').innerHTML = '';
            }, 3000);
        }

        window.loadLeaderboard = function(type) {
            const btnAll = document.getElementById('btnAllTime');
            const btn30 = document.getElementById('btn30Days');
            
            if (type === 'all') {
                btnAll.className = 'btn btn-primary';
                btn30.className = 'btn';
                btn30.style.background = '#6c757d';
                btn30.style.color = 'white';
            } else {
                btn30.className = 'btn btn-primary';
                btnAll.className = 'btn';
                btnAll.style.background = '#6c757d';
                btnAll.style.color = 'white';
            }
            
            if (!db) {
                document.getElementById('leaderboardList').innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Leaderboard requires connection to database</div>';
                return;
            }
            
            const field = type === 'all' ? 'totalScore' : 'score30Days';
            db.collection('users')
                .orderBy(field, 'desc')
                .limit(20)
                .get()
                .then(snapshot => {
                    displayLeaderboard(snapshot, field);
                })
                .catch(error => {
                    console.error('Error loading leaderboard:', error);
                    document.getElementById('leaderboardList').innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Error loading leaderboard</div>';
                });
        }

        // Helper functions
        window.getUserLevel = function(score) {
            for (let i = levels.length - 1; i >= 0; i--) {
                if (score >= levels[i].minScore) {
                    return levels[i];
                }
            }
            return levels[0];
        }

        window.getNextLevel = function(score) {
            const currentLevel = getUserLevel(score);
            const currentIndex = levels.findIndex(l => l.name === currentLevel.name);
            if (currentIndex < levels.length - 1) {
                return levels[currentIndex + 1];
            }
            return null;
        }

        window.createRouteQuestions = function() {
            return Object.entries(routeDiagrams).map(([key, route]) => ({
                type: 'route-diagram',
                routeKey: key,
                question: 'Which city and line is this?',
                correct: `${route.city} - ${route.line}`,
                wrong: [
                    'Toronto - Line 2 Bloor-Danforth',
                    'Vancouver - Expo Line', 
                    'Montreal - Green Line',
                    'Chicago - Blue Line'
                ].filter(opt => opt !== `${route.city} - ${route.line}`).slice(0, 3),
                answerType: 'multiple'
            }));
        }

        window.updateHomepage = function() {
            if (currentUser) updateUserDisplay();
            updateQuestionCounts();
            if (currentUser && currentUser.gameHistory) updateRecentActivity();
            updateStreakDisplay();
        }

        window.updateUserDisplay = function() {
            const score = currentUser ? (currentUser.totalScore || 0) : 0;
            const level = getUserLevel(score);
            document.getElementById('scoreDisplay').innerHTML = `⭐ ${score} pts<span class="user-level">${level.name}</span>`;
        }

        window.updateQuestionCounts = function() {
            const counts = {
                stations: 0,
                routes: 0,
                nextstation: 0,
                trivia: 0,
                geography: 0
            };
            
            allQuestions.forEach(q => {
                if (q.mode === 'systems') q.mode = 'trivia';
                if (counts[q.mode] !== undefined) {
                    counts[q.mode]++;
                }
            });
            
            counts.routes += Object.keys(routeDiagrams).length;
            
            document.getElementById('stationsCount').textContent = counts.stations;
            document.getElementById('routesCount').textContent = counts.routes;
            document.getElementById('nextstationCount').textContent = counts.nextstation;
            document.getElementById('triviaCount').textContent = counts.trivia;
            document.getElementById('geographyCount').textContent = counts.geography;
        }

        window.updateRecentActivity = function() {
            const container = document.getElementById('recentActivity');
            if (!container) return;
            
            if (!currentUser || !currentUser.gameHistory || currentUser.gameHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🚇</div>
                        <div>Start playing to see your activity</div>
                    </div>
                `;
                return;
            }
            
            const recent = currentUser.gameHistory.slice(-3).reverse();
            let html = '<div style="padding: 10px 0;">';
            
            recent.forEach(game => {
                const date = game.date.toDate ? game.date.toDate() : new Date(game.date);
                const dateStr = date.toLocaleDateString();
                html += `
                    <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                        <strong>${game.mode || 'Quiz'}</strong> - ${game.score} pts
                        <span style="color: #666; font-size: 0.9em; float: right;">${dateStr}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        window.updateProfile = function() {
            if (!currentUser) {
                // Show default values if no user
                document.getElementById('profileScore').textContent = '0';
                document.getElementById('profileScore30').textContent = '0';
                document.getElementById('profileGames').textContent = '0';
                document.getElementById('profileQuestions').textContent = '0';
                document.getElementById('currentLevelText').textContent = 'Rookie';
                document.getElementById('nextLevelText').textContent = 'Transit Fan (100 pts)';
                document.getElementById('levelProgressFill').style.width = '0%';
                document.getElementById('levelProgressText').textContent = '0 / 100 points';
                return;
            }
            
            const allTimeScore = currentUser.totalScore || 0;
            const score30Days = currentUser.score30Days || 0;
            
            document.getElementById('profileScore').textContent = allTimeScore;
            document.getElementById('profileScore30').textContent = score30Days;
            document.getElementById('profileGames').textContent = currentUser.gamesPlayed || 0;
            document.getElementById('profileQuestions').textContent = currentUser.questionsAdded || 0;
            
            const currentLevel = getUserLevel(allTimeScore);
            const nextLevel = getNextLevel(allTimeScore);
            
            document.getElementById('currentLevelText').textContent = currentLevel.name;
            
            if (nextLevel) {
                const progress = allTimeScore - currentLevel.minScore;
                const needed = nextLevel.minScore - currentLevel.minScore;
                const percentage = (progress / needed) * 100;
                
                document.getElementById('nextLevelText').textContent = `${nextLevel.name} (${nextLevel.minScore} pts)`;
                document.getElementById('levelProgressFill').style.width = `${percentage}%`;
                document.getElementById('levelProgressText').textContent = `${allTimeScore} / ${nextLevel.minScore} points`;
            } else {
                document.getElementById('nextLevelText').textContent = 'Max Level Reached!';
                document.getElementById('levelProgressFill').style.width = '100%';
                document.getElementById('levelProgressText').textContent = 'Metro Legend Status';
            }
        }

        window.displayLeaderboard = function(snapshot, scoreField) {
            let html = '';
            let rank = 1;
            
            snapshot.forEach(doc => {
                const user = doc.data();
                const score = user[scoreField] || 0;
                const isCurrentUser = currentUser && doc.id === currentUser.username;
                const level = getUserLevel(user.totalScore || 0);
                
                html += `
                    <div class="leaderboard-item" ${isCurrentUser ? 'style="background: #f0f4ff;"' : ''}>
                        <div>
                            <span class="leaderboard-rank">#${rank}</span>
                            <span class="leaderboard-name">
                                ${doc.id} ${isCurrentUser ? '(You)' : ''}
                                <span style="font-size: 0.8em; color: ${level.color};">[${level.name}]</span>
                            </span>
                        </div>
                        <div class="leaderboard-score">${score} pts</div>
                    </div>
                `;
                rank++;
            });
            
            if (!html) {
                html = '<div style="text-align: center; padding: 20px; color: #666;">No players yet</div>';
            }
            
            document.getElementById('leaderboardList').innerHTML = html;
        }

        window.showQuestion = function() {
            if (!currentQuiz || currentQuiz.currentIndex >= currentQuiz.questions.length) {
                endQuiz();
                return;
            }
            
            // Clear any existing timers
            if (hintTimer) clearTimeout(hintTimer);
            if (questionTimer) clearTimeout(questionTimer);
            if (autoAdvanceTimer) clearTimeout(autoAdvanceTimer);
            
            const question = currentQuiz.questions[currentQuiz.currentIndex];
            const progress = ((currentQuiz.currentIndex + 1) / currentQuiz.questions.length) * 100;
            
            // Update progress
            const progressBar = document.getElementById('progressBar');
            if (progressBar) progressBar.style.width = `${progress}%`;
            
            const currentQ = document.getElementById('currentQ');
            if (currentQ) currentQ.textContent = currentQuiz.currentIndex + 1;
            
            const quizScore = document.getElementById('quizScore');
            if (quizScore) quizScore.textContent = currentQuiz.score % 1 === 0 ? currentQuiz.score : currentQuiz.score.toFixed(1);
            
            const questionText = document.getElementById('questionText');
            if (questionText) questionText.textContent = question.question;
            
            // Reset hint state
            hintShown = false;
            const hintBox = document.getElementById('hintBox');
            if (hintBox) hintBox.style.display = 'none';
            
            if (question.hint && hintBox) {
                hintTimer = setTimeout(() => {
                    if (!hintShown) {
                        const hintText = document.getElementById('hintText');
                        if (hintText) hintText.textContent = question.hint;
                        hintBox.style.display = 'block';
                        hintShown = true;
                    }
                }, 10000);
            }
            
            const contentDiv = document.getElementById('questionContent');
            if (contentDiv) {
                if (question.type === 'route-diagram') {
                    const route = routeDiagrams[question.routeKey];
                    contentDiv.innerHTML = `
                        <div class="route-diagram">
                            <div class="route-line" style="color: ${route.color};">
                                ${route.stations.map((s, i) => 
                                    `<div class="station-dot ${i === 0 || i === route.stations.length - 1 ? 'terminal' : ''}"></div>`
                                ).join('')}
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9em;">
                                <span>${route.stations[0]}</span>
                                <span>${route.stations[route.stations.length - 1]}</span>
                            </div>
                        </div>
                    `;
                } else {
                    contentDiv.innerHTML = '';
                }
            }
            
            const answerArea = document.getElementById('answerArea');
            if (answerArea) {
                if (question.answerType === 'type') {
                    answerArea.innerHTML = `
                        <input type="text" class="type-answer-input" id="typeAnswer" placeholder="Type your answer..." onkeypress="checkTypeAnswer(event)">
                        <button class="btn btn-primary" onclick="submitTypeAnswer()">Submit Answer</button>
                    `;
                    setTimeout(() => {
                        const input = document.getElementById('typeAnswer');
                        if (input) input.focus();
                    }, 100);
                } else {
                    const options = [question.correct, ...question.wrong].sort(() => Math.random() - 0.5);
                    answerArea.innerHTML = `
                        <div class="options-grid">
                            ${options.map(option => `
                                <button class="option-btn" onclick="checkAnswer('${option.replace(/'/g, "\\'")}', '${question.correct.replace(/'/g, "\\'")}')">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    `;
                }
            }
            
            // Hide feedback from previous question
            const feedback = document.getElementById('feedback');
            if (feedback) feedback.classList.add('hidden');
        }

        window.processAnswer = function(isCorrect, correct, selected) {
            if (hintTimer) clearTimeout(hintTimer);
            if (questionTimer) clearTimeout(questionTimer);
            
            let pointsEarned = 0;
            if (isCorrect) {
                pointsEarned = hintShown ? 0.5 : 1;
                currentQuiz.score += pointsEarned;
                const scoreEl = document.getElementById('quizScore');
                if (scoreEl) {
                    scoreEl.textContent = currentQuiz.score % 1 === 0 ? currentQuiz.score : currentQuiz.score.toFixed(1);
                }
            }
            
            const question = currentQuiz.questions[currentQuiz.currentIndex];
            
            if (question.answerType === 'type') {
                const typeInput = document.getElementById('typeAnswer');
                if (typeInput) typeInput.disabled = true;
                const submitBtn = typeInput ? typeInput.nextElementSibling : null;
                if (submitBtn) submitBtn.disabled = true;
            } else {
                const buttons = document.querySelectorAll('.option-btn');
                buttons.forEach(btn => {
                    btn.onclick = null;
                    btn.classList.add('disabled');
                    
                    if (btn.textContent.trim() === correct) {
                        btn.classList.add('correct');
                    } else if (selected && btn.textContent.trim() === selected && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                });
            }
            
            const feedback = document.getElementById('feedback');
            if (feedback) {
                feedback.classList.remove('hidden');
                feedback.style.background = isCorrect ? '#d4edda' : '#f8d7da';
                feedback.style.color = isCorrect ? '#155724' : '#721c24';
                
                let feedbackText = isCorrect ? '✓ Correct' : '✗ Incorrect';
                if (isCorrect && hintShown) {
                    feedbackText += ' (Half point with hint)';
                }
                if (!isCorrect) {
                    feedbackText += `<br>The answer is: <strong>${correct}</strong>`;
                }
                
                // Add countdown to next question
                feedbackText += '<div style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">Next question in <span id="countdown" style="font-size: 1.2em;">2</span> seconds...</div>';
                
                feedback.innerHTML = feedbackText;
                
                // Update countdown
                setTimeout(() => {
                    const countdown = document.getElementById('countdown');
                    if (countdown) countdown.textContent = '1';
                }, 1000);
            }
            
            // Auto-advance to next question after 2 seconds
            setTimeout(() => {
                nextQuestion();
            }, 2000);
        }

        window.endQuiz = function() {
            // Clear all timers
            if (hintTimer) clearTimeout(hintTimer);
            if (questionTimer) clearTimeout(questionTimer);
            if (autoAdvanceTimer) clearTimeout(autoAdvanceTimer);
            
            const scoreDisplay = currentQuiz.score % 1 === 0 ? currentQuiz.score : currentQuiz.score.toFixed(1);
            const percentage = Math.round((currentQuiz.score / currentQuiz.questions.length) * 100);
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (currentUser) {
                const lastPlayed = currentUser.lastPlayed;
                if (lastPlayed) {
                    const lastDate = lastPlayed.toDate ? lastPlayed.toDate() : new Date(lastPlayed);
                    lastDate.setHours(0, 0, 0, 0);
                    
                    const daysDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                    
                    if (daysDiff === 1) {
                        currentStreak++;
                    } else if (daysDiff > 1) {
                        currentStreak = 1;
                    }
                } else {
                    currentStreak = 1;
                }
                
                const pointsEarned = Math.floor(currentQuiz.score);
                currentUser.totalScore = (currentUser.totalScore || 0) + pointsEarned;
                currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;
                currentUser.correctAnswers = (currentUser.correctAnswers || 0) + currentQuiz.score;
                currentUser.currentStreak = currentStreak;
                currentUser.lastPlayed = new Date();
                
                if (!currentUser.gameHistory) currentUser.gameHistory = [];
                currentUser.gameHistory.push({
                    date: new Date(),
                    score: pointsEarned,
                    mode: currentQuiz.mode
                });
                
                calculate30DayScore();
                
                // Save to localStorage for persistence
                localStorage.setItem('transitTriviaScore', currentUser.totalScore.toString());
                localStorage.setItem('transitTriviaGames', currentUser.gamesPlayed.toString());
                
                // Save to database if available
                if (db && currentUser.username) {
                    db.collection('users').doc(currentUser.username).update({
                        totalScore: currentUser.totalScore,
                        score30Days: currentUser.score30Days,
                        gamesPlayed: currentUser.gamesPlayed,
                        correctAnswers: currentUser.correctAnswers,
                        lastPlayed: new Date(),
                        currentStreak: currentStreak,
                        gameHistory: currentUser.gameHistory
                    }).catch(error => {
                        console.error('Error saving game results:', error);
                    });
                }
            }
            
            const level = getUserLevel(currentUser ? currentUser.totalScore : 0);
            
            document.getElementById('quizSection').innerHTML = `
                <div class="section" style="text-align: center;">
                    <h2 style="color: #1e3c72; margin-bottom: 20px;">Quiz Complete 🎉</h2>
                    <div style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 30px; border-radius: 12px; margin: 20px 0;">
                        <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${scoreDisplay}/${currentQuiz.questions.length}</div>
                        <div style="font-size: 1.2em; opacity: 0.95;">${percentage}% Accuracy</div>
                    </div>
                    <div style="color: #666; margin-bottom: 10px;">Level: <strong style="color: ${level.color};">${level.name}</strong></div>
                    ${currentStreak > 1 ? `<div style="color: #666; margin-bottom: 20px;">🔥 ${currentStreak} day streak</div>` : ''}
                    <button class="btn btn-primary" onclick="goHome()">Back to Home</button>
                </div>
            `;
        }

        window.calculate30DayScore = function() {
            if (!currentUser || !currentUser.gameHistory) {
                currentUser.score30Days = 0;
                return;
            }
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            currentUser.score30Days = currentUser.gameHistory
                .filter(game => {
                    const gameDate = game.date.toDate ? game.date.toDate() : new Date(game.date);
                    return gameDate >= thirtyDaysAgo;
                })
                .reduce((sum, game) => sum + (game.score || 0), 0);
        }

        window.updateStreakDisplay = function() {
            const text = document.getElementById('streakText');
            if (!text) return;
            
            if (currentStreak === 0) {
                text.textContent = '⚡ Take a quiz to start your streak';
            } else if (currentStreak === 1) {
                text.textContent = '⚡ 1 day streak started';
            } else if (currentStreak < 7) {
                text.textContent = `🔥 ${currentStreak} day streak`;
            } else {
                text.textContent = `🔥 ${currentStreak} day streak • Transit champion`;
            }
        }

        window.loadStreak = function() {
            if (!currentUser) return;
            
            const lastPlayed = currentUser.lastPlayed;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (lastPlayed) {
                const lastDate = lastPlayed.toDate ? lastPlayed.toDate() : new Date(lastPlayed);
                lastDate.setHours(0, 0, 0, 0);
                
                const daysDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === 0) {
                    currentStreak = currentUser.currentStreak || 0;
                } else if (daysDiff === 1) {
                    currentStreak = currentUser.currentStreak || 0;
                } else {
                    currentStreak = 0;
                }
            } else {
                currentStreak = 0;
            }
            
            updateStreakDisplay();
        }

        window.loadQuestions = function() {
            db.collection('questions').get().then(snapshot => {
                allQuestions = [];
                snapshot.forEach(doc => {
                    allQuestions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                if (allQuestions.length === 0) {
                    sampleQuestions.forEach(q => {
                        db.collection('questions').add({
                            ...q,
                            addedBy: 'System',
                            addedAt: new Date()
                        });
                    });
                    allQuestions = sampleQuestions;
                }
                
                updateQuestionCounts();
            }).catch(error => {
                console.error('Error loading questions:', error);
                allQuestions = sampleQuestions;
                updateQuestionCounts();
            });
        }

        window.createAnonymousUser = function() {
            const username = 'Player' + Math.floor(Math.random() * 10000);
            localStorage.setItem('transitTriviaUser', username);
            
            currentUser = {
                username: username,
                totalScore: 0,
                score30Days: 0,
                gamesPlayed: 0,
                questionsAdded: 0,
                correctAnswers: 0,
                lastPlayed: null,
                currentStreak: 0,
                gameHistory: []
            };
            
            if (db) {
                db.collection('users').doc(username).set({
                    ...currentUser,
                    joinedAt: new Date(),
                    lastPlayed: new Date()
                }).catch(error => {
                    console.error('Error creating user in database:', error);
                });
            }
            
            updateUserDisplay();
        }

        window.loadUser = function(username) {
            if (!db) {
                // Create local user if database not available
                currentUser = {
                    username: username,
                    totalScore: 0,
                    score30Days: 0,
                    gamesPlayed: 0,
                    questionsAdded: 0,
                    correctAnswers: 0,
                    lastPlayed: null,
                    currentStreak: 0,
                    gameHistory: []
                };
                updateUserDisplay();
                return;
            }
            
            db.collection('users').doc(username).get().then(doc => {
                if (doc.exists) {
                    currentUser = doc.data();
                    currentUser.username = username;
                    calculate30DayScore();
                    updateUserDisplay();
                } else {
                    createAnonymousUser();
                }
            }).catch(error => {
                console.error('Error loading user:', error);
                createAnonymousUser();
            });
        }

        window.initializeApp = function() {
            const savedUsername = localStorage.getItem('transitTriviaUser');
            if (savedUsername) {
                loadUser(savedUsername);
            } else {
                createAnonymousUser();
            }
            
            loadQuestions();
            loadStreak();
            updateHomepage();
        }

        // Load Firebase
        const script1 = document.createElement('script');
        script1.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js';
        document.head.appendChild(script1);

        script1.onload = function() {
            const script2 = document.createElement('script');
            script2.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js';
            document.head.appendChild(script2);
            
            script2.onload = function() {
                const firebaseConfig = {
                    apiKey: "AIzaSyCka6MweRe1EThGRTkZjwj-mWswvJGNU",
                    authDomain: "geoquizr.firebaseapp.com",
                    projectId: "geoquizr",
                    storageBucket: "geoquizr.firebasestorage.app",
                    messagingSenderId: "628669854362",
                    appId: "1:628669854362:web:72e9fc1f98ec55598ac023"
                };

                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Load data from Firebase
                loadQuestionsFromDB();
                loadUserFromDB();
            };
        };

        // Initialize with sample data immediately
        window.addEventListener('DOMContentLoaded', function() {
            // Start with sample data so app works immediately
            allQuestions = sampleQuestions;
            
            // Create temp user if not exists
            const savedUsername = localStorage.getItem('transitTriviaUser');
            if (savedUsername) {
                currentUser = {
                    username: savedUsername,
                    totalScore: parseInt(localStorage.getItem('transitTriviaScore') || '0'),
                    score30Days: 0,
                    gamesPlayed: parseInt(localStorage.getItem('transitTriviaGames') || '0'),
                    questionsAdded: 0,
                    correctAnswers: 0,
                    lastPlayed: null,
                    currentStreak: 0,
                    gameHistory: []
                };
            } else {
                const username = 'Player' + Math.floor(Math.random() * 10000);
                localStorage.setItem('transitTriviaUser', username);
                currentUser = {
                    username: username,
                    totalScore: 0,
                    score30Days: 0,
                    gamesPlayed: 0,
                    questionsAdded: 0,
                    correctAnswers: 0,
                    lastPlayed: null,
                    currentStreak: 0,
                    gameHistory: []
                };
            }
            
            // Initialize displays
            updateUserDisplay();
            updateQuestionCounts();
            updateStreakDisplay();
            updateRecentActivity();
        });

        // Firebase-specific functions
        window.loadQuestionsFromDB = function() {
            if (!db) return;
            db.collection('questions').get().then(snapshot => {
                if (snapshot.size > 0) {
                    const dbQuestions = [];
                    snapshot.forEach(doc => {
                        dbQuestions.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    // Merge database questions with sample questions
                    allQuestions = [...sampleQuestions, ...dbQuestions];
                    updateQuestionCounts();
                }
            }).catch(error => {
                console.error('Error loading questions from database:', error);
            });
        }

        window.loadUserFromDB = function() {
            if (!db) return;
            const savedUsername = localStorage.getItem('transitTriviaUser');
            if (savedUsername) {
                loadUser(savedUsername);
            } else {
                createAnonymousUser();
            }
            loadStreak();
        }
    </script>
</body>
</html>
